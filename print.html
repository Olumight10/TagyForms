<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Men's Convocation 2025 — Registrars Printing Platform</title>
  <style>
    :root{--accent:#2b6cb0;--muted:#f3f4f6;--black:#0b0b0b}
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; margin:18px; background:#e6f3e6; color:#111}
    header{text-align:center;margin-bottom:18px}


    .header{
      display: flex;
      gap: 2rem;
      text-align: center;
      width: 100%;
      justify-content: center;
    }

    .header h1{
      margin-bottom: 0;
    }

    .header h2{
      font-weight: 100;
      margin: 0;
      color: black;
      font-weight: 200;
    }

    /* Navbar container */
    nav {
      background: #e6f3e6;
      padding: 1rem 0;
    }

    /* Align nav items */
    nav ul {
      display: flex;
      list-style: none;
      gap: 2rem;
      justify-content: center;
      width: 100%;
      padding: 0;
      margin: 0;
    }

    /* Link style */
    nav a {
      text-decoration: none;
      color: #1b5e20;
      padding: 0.6rem 1.5rem;
      border-radius: 9999px; /* capsule shape */
      background: #cde9cd; /* slightly deeper than page background */
      transition: all 0.3s ease;
      font-weight: 500;
    }

    /* Hover state */
    nav a:hover {
      background: #4caf50;
      color: white;
      box-shadow: 0 3px 8px rgba(0,0,0,0.15);
    }

    /* Active link (add .active in HTML) */
    nav a.active {
      background: #388e3c;
      color: white;
      box-shadow: inset 0 3px 6px rgba(0,0,0,0.2);
    }

    .logo {
      width: 100px;
      height: 100px;
    }



    .controls{display:flex;gap:12px;align-items:flex-end;margin:16px 0}
    .central-control{display:flex;gap:12px;flex:1; justify-content: space-between;}
    label{display:block;font-size:13px;color:#333;margin-bottom:6px}
    select,input[type="number"],input[type="text"]{padding:8px 10px;border:1px solid #ddd;border-radius:6px;width:220px}
    button{padding:10px 14px;border-radius:8px;border:none;background:#388e3c;color:white;cursor:pointer}
    button[disabled]{opacity:.45;cursor:not-allowed}
    .form-area{margin:12px 0;padding:12px;border:1px dashed #e5e7eb;border-radius:8px;background:white}

    /* A4 preview box */
    .preview-wrap{margin-top:18px;display:flex;gap:18px}
    .preview-panel{flex:1}
    .a4{width:210mm;height:297mm;border:1px solid #ddd;background:white;position:relative;padding:12mm;box-sizing:border-box}
    .a4 .grid{display:grid;grid-template-columns:1fr 1fr;grid-template-rows:1fr 1fr 1fr;gap:6mm;height:100%}
.slot {
  border: 1px dashed #e2e8f0;
  position: relative;
  overflow: hidden;
  background: #fff;
  display: flex;
  align-items: stretch;
  justify-content: center;
}

.tag {
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
  box-sizing: border-box;
  overflow: hidden;
}

.tag-header img {
  width: 100%;
  max-height: 80px;
  object-fit: contain;
  display: block;
}

.tag-body {
  flex: 1;                  /* expand to fill vertical space */
  display: flex;
  flex-direction: column;
  padding: 10px;
  gap: 10px;
  justify-content: space-between; /* distribute venue/person/meta vs footer */
}

.venue {
  text-align: center;
  font-weight: bold;
  font-size: 14px;
}

.person {
  display: flex;
  align-items: center;
  gap: 10px;
}

.avatar img {
  width: 64px;
  height: 64px;
  border-radius: 6px;
  object-fit: cover;
  border: 1px solid #ccc;
}

.pdetails .name {
  font-weight: bold;
  font-size: 16px;
}

.pdetails .small {
  font-size: 13px;
  color: #555;
}

.meta {
  font-size: 12px;
  line-height: 1.4;
}

.footer {
  font-size: 11px;
  text-align: center;
  border-top: 1px solid #ddd;
  padding-top: 5px;
}





    /* small helper */
    .stack-list{margin-top:8px;display:flex;gap:6px;flex-wrap:wrap}
    .stack-chip{background:#eef2ff;padding:6px 8px;border-radius:999px;font-size:12px;border:1px solid #dbeafe}


@page {
  size: A4;
  margin: 0;   /* remove browser print margins */
}

@media print {
  body {
    margin: 0;
    background: #fff;
  }

  /* hide non-print elements */
  .header,
  .navbar,
  .controls,
  .form-area,
  .otherctrl,
  .stacker {
    display: none !important;
  }

  .preview-wrap {
    display: block !important;
    margin: 0 auto;
  }

  /* strict A4 page */
  #a4Preview {
    width: 210mm;
    height: 297mm;
    margin: 0 auto;
    padding: 6mm;               /* controlled padding */
    border: none !important;
    box-shadow: none !important;
    background: #fff;
    overflow: hidden;           /* clip overflow */
    page-break-after: always;
    box-sizing: border-box;
  }

  /* fixed 2x3 grid */
  #a4Preview .grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-rows: 1fr 1fr 1fr;
    gap: 6mm;
    width: 100%;
    height: 100%;
    box-sizing: border-box;
  }

  /* make sure slots don’t expand outside */
  .slot {
    overflow: hidden;
  }
}






  </style>
</head>
<body>
    <div class="header">

      <img src="logos.png" alt="Logo" class="logo">

      <div class="writeup">
        <h1>Men's Convocation 2025</h1>
        <h2>Registrar's Platform</h2>
      </div>
    </div>

    <nav class="navbar">
      <ul>
        <li><a href="index.html" >Register</a></li>
        <li><a href="print.html" class="active">Print</a></li>
      </ul>
    </nav>

  <div class="controls">
    <div class="central-control">
      <div>
        <label>Auto Print</label>
        <button class="act-btn" id="auto_print">Auto Stack</button>
      </div>

      <div>
        <label>Manual pick Print</label>
        <div class="func">
          <input type="text" id="serial_input" placeholder="Input serial no">
          <input type="text" id="tag_input" placeholder="Input tag position">
          <button class="act-btn" id="manual_print">stack</button>
          <button class="act-btn" id="last_print">print last</button>
        </div>
      </div>

        <div>
          <label>Print check</label>
          <div class="func">
            <input type="text" id="check_serial_input" placeholder="Input serial no">
            <button class="act-btn" id="manual_check">check</button>
          </div>
        </div>

        <div>
          <label>Get Serial No</label>
          <div class="func">
              <input type="text" id="surname" placeholder="Input Surname">
              <input type="text" id="firstname" placeholder="Input First Name">
              <button class="act-btn" id="search">search</button>
          </div>
        </div>
    </div>

  </div>

  <div class="form-area" id="formArea">
    <!-- dynamic content inserted by JS -->
    <div style="color:#6b7280">Active Rows</div>
  </div>

  <div  style="display:flex;gap:12px;align-items:center" class="otherctrl">
    <button id="printBtn" style="display:none">Print</button>
    <div id="stackChips" style="margin-left:8px"></div>
  </div>

  <div class="preview-wrap">
    <div class="preview-panel">
      <div class="a4" id="a4Preview" aria-label="A4 preview">
        <div class="grid" id="grid">
          <!-- six slots -->
          <div class="slot" data-pos="1"></div>
          <div class="slot" data-pos="2"></div>
          <div class="slot" data-pos="3"></div>
          <div class="slot" data-pos="4"></div>
          <div class="slot" data-pos="5"></div>
          <div class="slot" data-pos="6"></div>
        </div>
      </div>
    </div>

    <div style="width:340px" class="stacker">
      <h3>Stacked tags</h3>
      <div id="stackList"></div>
    </div>
  </div>

  <script>
    const formArea = document.getElementById('formArea');
    const printBtn = document.getElementById('printBtn');
    const grid = document.getElementById('grid');
    const stackList = document.getElementById('stackList');
    const stackChips = document.getElementById('stackChips');
    const manualPrint = document.getElementById('manual_print');
    const lastPrint = document.getElementById('last_print');
    const autoPrint = document.getElementById('auto_print');
    const manualCheck = document.getElementById('manual_check');
    const searcher = document.getElementById('search');
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbzT-Iu2fUvfxwUMS2r4bUOmDFlwP6fpA8xGPFwgSOfbmB2ygMpEj0cWA3OBZNXB-_uo_A/exec';

    const state = { currentData: null, slots: Array(6).fill(null)};


function buildTagDOM(info) {
  const wrapper = document.createElement("div");
  wrapper.className = "tag";

  // Format serial number as MC25_###
  const paddedSerial = String(info.serial || "0").padStart(3, "0");
  const code = `MC25_${paddedSerial}`;

  wrapper.innerHTML = `
    <div class="tag-header">
      <img src="banner.png" alt="Banner">
    </div>

    <div class="tag-body">
      <div class="venue">Restoration To Glory, Honour & Dominion</div>

      <div class="person">
        <div class="avatar">
          <img src="himage.png" alt="Avatar">
        </div>
        <div class="pdetails">
          <div class="name">${escapeHTML(
            [info.title, info.surname].filter(Boolean).join(" ")
          )}</div>
          <div class="small">${escapeHTML(
            [info.firstname, info.othernames].filter(Boolean).join(" ")
          )}</div>
        </div>
      </div>

      <div class="meta">
        <div><strong>State:</strong> ${escapeHTML(info.state || "-")}</div>
        <div><strong>LGA:</strong> ${escapeHTML(info.lga || "-")}</div>
        <div><strong>Church:</strong> ${escapeHTML(info.church || "-")}</div>
      </div>

      <div class="footer">
        <div class="online">Online Registration Tag</div>
        <div class="phcode"><strong>${escapeHTML(code)}</strong></div>
      </div>
    </div>
  `;
  return wrapper;
}

      function escapeHTML(s) {
        if (!s) return "";
        return String(s)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");
      }


    function escapeHTML(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }



    function placeInSlot(pos, data){
      const index = pos - 1;
      state.slots[index] = {...data};
      
    }


    function renderSlots(){
      const slotEls = document.querySelectorAll('.slot');
      slotEls.forEach(el => {
        const p = Number(el.dataset.pos);
        const d = state.slots[p-1];
        el.innerHTML = '';
        if(d){
          const tag = buildTagDOM(d);
          el.appendChild(tag);
          el.style.border = "1px solid #000";   // solid black if filled
        } else {
          el.style.border = "1px dashed #e2e8f0"; // faint dashed if empty
        }
      });
    }



function renderStackList() {
  stackList.innerHTML = '';
  stackChips.innerHTML = '';

  let hasSlot = false;

  state.slots.forEach((s, i) => {
    if (s) {
      hasSlot = true;

      const div = document.createElement('div');
      div.style.padding = '8px';
      div.style.borderBottom = '1px solid #f1f5f9';
      div.innerHTML = `<strong>Pos ${i + 1}:</strong> ${escapeHTML(
        [s.title, s.surname, s.firstname].filter(Boolean).join(' ')
      )} <button data-pos='${i + 1}' style='margin-left:8px'>Remove</button>`;

      const btn = div.querySelector('button');
      btn.addEventListener('click', () => {
        state.slots[i] = null;
        renderSlots();
        renderStackList();
        if (state.slots.every(x => !x)) printBtn.style.display = 'none';
      });

      stackList.appendChild(div);

      const chip = document.createElement('span');
      chip.className = 'stack-chip';
      chip.textContent = `#${i + 1} ${s.surname || s.firstname || 'Participant'}`;
      stackChips.appendChild(chip);
    }
  });

  // Add "Clear All Slots" button if at least one slot is filled
  if (hasSlot) {
    const clearBtn = document.createElement('button');
    clearBtn.textContent = 'Clear All Slots';
    clearBtn.style.marginTop = '10px';
    clearBtn.style.background = '#d32f2f';
    clearBtn.style.color = 'white';
    clearBtn.style.borderRadius = '6px';
    clearBtn.style.padding = '6px 12px';
    clearBtn.style.cursor = 'pointer';

    clearBtn.addEventListener('click', () => {
      state.slots = state.slots.map(() => null); // reset all slots
      renderSlots();
      renderStackList();
      printBtn.style.display = 'none';
    });

    stackList.appendChild(clearBtn);
  }
}



    printBtn.addEventListener('click', () => {
      window.print();

      // After printing, clear all slots
      state.slots = state.slots.map(() => null);
      renderSlots();
      renderStackList();
      printBtn.style.display = 'none'; // hide again until slots are filled
    });



    autoPrint.addEventListener('click', async () => {
      try {
        const response = await fetch(
          "https://script.google.com/macros/s/AKfycbzT-Iu2fUvfxwUMS2r4bUOmDFlwP6fpA8xGPFwgSOfbmB2ygMpEj0cWA3OBZNXB-_uo_A/exec",
          {
            method: "POST",
            body: JSON.stringify({ action: "autoGet" }),
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
          }
        );

        const result = await response.json();

        if (result.status === "success" && Array.isArray(result.data)) {
          console.log("Participants received:", result.data);
          console.log("lastdone:", result.lastDoneRow);

          // ✅ Clear all slots before adding new data
          state.slots = new Array(state.slots.length).fill(null);

          // Assign slots
          result.data.forEach(participant => {
            const slotIndex = state.slots.findIndex(s => s === null);
            if (slotIndex !== -1) {
              placeInSlot(slotIndex + 1, participant);
            }
          });

          // ✅ Render everything once after loop
          renderSlots();
          renderStackList();

          if (state.slots.some(s => s)) {
            printBtn.style.display = "inline-block";
          }
        } else {
          console.error("Backend returned error:", result);
        }
      } catch (error) {
        console.error("Fetch error:", error);
      }
    });



    manualPrint.addEventListener('click', async () => {
      const serialInput = document.getElementById('serial_input');
      const tagInput = document.getElementById('tag_input');

      const serialNo = serialInput.value.trim();
      const tagPos = Number(tagInput.value.trim());

      if (!serialNo) {
        alert("Please enter a serial number.");
        return;
      }


      try {
        const response = await fetch(
          "https://script.google.com/macros/s/AKfycbzT-Iu2fUvfxwUMS2r4bUOmDFlwP6fpA8xGPFwgSOfbmB2ygMpEj0cWA3OBZNXB-_uo_A/exec",
          {
            method: "POST",
            body: JSON.stringify({ action: "manualGet", serial: serialNo }),
            headers: { "Content-Type": "application/x-www-form-urlencoded" }, // ✅ proper JSON
          }
        );

        const result = await response.json();

        if (result.status === "success") {

          if (!tagPos || tagPos < 1 || tagPos > state.slots.length) {

              const nextPos = state.slots.findIndex(x => !x);

              if (nextPos === -1) {
                alert("No empty slots available.");
                return;
              }

              // Place participant in the next empty slot
              placeInSlot(nextPos + 1, result.data); // +1 because slot numbering starts at 1
            }
          else {
            // Place participant directly in the chosen slot
            placeInSlot(tagPos, result.data);
          }

          // Render once after update
          renderSlots();
          renderStackList();

          // Show print button
          printBtn.style.display = "inline-block";

          console.log(
            `Participant placed in slot ${tagPos}:`,
            result.data
          );

        serialInput.value = '';
        tagInput.value = '';
        } else if (result.status === "not_found") {
          alert("Serial number not found in sheet.");
        } else {
          console.error("Unexpected response:", result);
        }
      } catch (error) {
        console.error("Error fetching participant:", error);
      }
    });

    lastPrint.addEventListener('click', async () => {
      const serialInput = document.getElementById('serial_input');
      const tagInput = document.getElementById('tag_input');

      const serialNo = serialInput.value.trim();
      const tagPos = Number(tagInput.value.trim());

      try {
        const response = await fetch(
          "https://script.google.com/macros/s/AKfycbzT-Iu2fUvfxwUMS2r4bUOmDFlwP6fpA8xGPFwgSOfbmB2ygMpEj0cWA3OBZNXB-_uo_A/exec",
          {
            method: "POST",
            body: JSON.stringify({ action: "manualGet", serial: 'last' }),
            headers: { "Content-Type": "application/x-www-form-urlencoded" }, // ✅ proper JSON
          }
        );

        const result = await response.json();

        if (result.status === "success") {


          if (!tagPos || tagPos < 1 || tagPos > state.slots.length) {

              const nextPos = state.slots.findIndex(x => !x);

              if (nextPos === -1) {
                alert("No empty slots available.");
                return;
              }

              // Place participant in the next empty slot
              placeInSlot(nextPos + 1, result.data); // +1 because slot numbering starts at 1
            }
          else {
            // Place participant directly in the chosen slot
            placeInSlot(tagPos, result.data);
          }
          
          // Render once after update
          renderSlots();
          renderStackList();

          // Show print button
          printBtn.style.display = "inline-block";

          console.log(
            `Participant placed in slot ${tagPos}:`,
            result.data
          );
          // ✅ Clear the inputs after use
          serialInput.value = '';
          tagInput.value = '';
        } else if (result.status === "not_found") {
          alert("Serial number not found in sheet.");
        } else {
          console.error("Unexpected response:", result);
        }
      } catch (error) {
        console.error("Error fetching participant:", error);
      }
    });


    manualCheck.addEventListener('click', async () => {
    const serialNo = document.getElementById('check_serial_input').value.trim();

    if (!serialNo) {
      alert("Please enter a serial number.");
      return;
    }

    try {
      const response = await fetch("https://script.google.com/macros/s/AKfycbzT-Iu2fUvfxwUMS2r4bUOmDFlwP6fpA8xGPFwgSOfbmB2ygMpEj0cWA3OBZNXB-_uo_A/exec", {
        method: "POST",
        body: JSON.stringify({ action: "checkout", serial: serialNo }),
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
      });

      const result = await response.json();

      if (result.status === "success") {
            const displayDiv = formArea.querySelector('div');
            displayDiv.innerHTML = `
              <span style="font-weight:bold; color:#000000">Message:</span> 
              <span style="color:#1a1a1a">${result.message}</span>
            `;
      } else if (result.status === "not_found") {
        alert("Serial not found in sheet.");
      } else {
        console.error("Unexpected response:", result);
      }
    } catch (error) {
      console.error("Error during checkout:", error);
      alert("An error occurred while checking out.");
    }
  });



    searcher.addEventListener('click', async () => {
      const surname = document.getElementById('surname').value.trim();
      const firstname = document.getElementById('firstname').value.trim();

      if (!surname || !firstname) {
        alert("Please enter both surname and firstname");
        return;
      }

      try {
        const response = await fetch("https://script.google.com/macros/s/AKfycbzT-Iu2fUvfxwUMS2r4bUOmDFlwP6fpA8xGPFwgSOfbmB2ygMpEj0cWA3OBZNXB-_uo_A/exec", {
          method: "POST",
          body: JSON.stringify({
            action: "manualSearch",
            surname: surname,
            firstname: firstname
          }),
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
          },
        });

        const result = await response.json();

        if (result.status === "success" && result.data) {
          const { surname, firstname, serial, printed } = result.data;

        const displayDiv = formArea.querySelector('div');
        displayDiv.innerHTML = `
          <span style="font-weight:bold; color:#000000">Name:</span> 
            <span style="color:#1a1a1a">${surname} ${firstname}</span> | 
          <span style="font-weight:bold; color:#000000">Serial No:</span> 
            <span style="color:#1a1a1a">${serial}</span> | 
          <span style="font-weight:bold; color:#000000">Print Status:</span> 
            <span style="color:#1a1a1a">${printed}</span>
        `;
        } else {
          alert("No match found.");
        }
      } catch (error) {
        console.error("Fetch error:", error);
        alert("Something went wrong. Please try again.");
      }
    });


    renderSlots();

  </script>
</body>
</html>
